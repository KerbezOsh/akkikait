<!DOCTYPE html>
<html lang="ky">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–ê–∫—ã–π–∫–∞—Ç AI ‚Äî –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–¥—ã–Ω —Å–∞–Ω–∞—Ä–∏–ø—Ç–∏–∫ —é—Ä–∏—Å—Ç–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #1d4ed8 100%);
        }
        
        .gradient-btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
        
        .gradient-btn:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 140px;
            height: 36px;
            background: rgba(255,255,255,0.15);
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: calc(50% - 3px);
            height: 30px;
            background: white;
            border-radius: 15px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .toggle-switch.ru::before {
            left: calc(50%);
        }
        
        .toggle-labels {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
        }
        
        .toggle-label {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            transition: color 0.3s;
            z-index: 1;
        }
        
        .toggle-switch:not(.ru) .toggle-label:first-child {
            color: #1e3a8a;
        }
        
        .toggle-switch:not(.ru) .toggle-label:last-child {
            color: rgba(255,255,255,0.8);
        }
        
        .toggle-switch.ru .toggle-label:first-child {
            color: rgba(255,255,255,0.8);
        }
        
        .toggle-switch.ru .toggle-label:last-child {
            color: #1e3a8a;
        }
        
        /* Sidebar */
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
                position: relative;
            }
            
            .sidebar.desktop-closed {
                transform: translateX(-100%);
                position: fixed;
            }
        }
        
        .chat-item {
            transition: all 0.2s ease;
        }
        
        .chat-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .chat-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid #3b82f6;
        }
        
        /* Loading Animation */
        .skeleton {
            background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .loader-dots {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .loader-dots span {
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .loader-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loader-dots span:nth-child(2) { animation-delay: -0.16s; }
        .loader-dots span:nth-child(3) { animation-delay: 0s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Fade In */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Response Formatting */
        .response-text {
            line-height: 1.9;
        }
        
        .response-text p {
            margin-bottom: 1rem;
        }
        
        .response-text strong {
            color: #1e3a8a;
            font-weight: 700;
        }
        
        .response-text ul, .response-text ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .response-text li {
            margin-bottom: 0.5rem;
        }
        
        .response-text h3, .response-text h4 {
            color: #1e3a8a;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        
        .response-text code {
            background: #eff6ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #1e40af;
        }
        
        .response-text blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
            margin: 1rem 0;
            background: #eff6ff;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
        }
        
        /* Mobile Menu */
        .mobile-menu {
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-menu.open {
            transform: translateX(0);
        }
        
        /* Quick buttons scroll */
        .quick-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .quick-scroll::-webkit-scrollbar {
            display: none;
        }
        
        /* Touch feedback */
        .touch-btn {
            transition: transform 0.1s, opacity 0.1s;
        }
        
        .touch-btn:active {
            transform: scale(0.97);
            opacity: 0.9;
        }
        
        /* Pulse animation for status */
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Scrollbar for sidebar */
        .sidebar-scroll {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        
        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }
        
        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        
        /* Message bubbles */
        .user-message {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .ai-message {
            background: white;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex">
    <!-- Sidebar - Chat History -->
    <aside id="sidebar" class="sidebar fixed lg:relative inset-y-0 left-0 w-72 bg-white border-r border-gray-200 z-40 flex flex-col">
        <!-- Sidebar Header -->
        <div class="p-4 border-b border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 gradient-bg rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                    </div>
                    <span class="font-bold text-gray-800" data-i18n="chatHistory">–ß–∞—Ç—Ç–∞—Ä —Ç–∞—Ä—ã—Ö—ã</span>
                </div>
                <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-gray-100 rounded-lg touch-btn">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- New Chat Button -->
            <button onclick="startNewChat()" class="w-full flex items-center gap-3 px-4 py-3 gradient-btn text-white rounded-xl font-semibold touch-btn hover:shadow-lg transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span data-i18n="newChat">–ñ–∞“£—ã —á–∞—Ç</span>
            </button>
        </div>
        
        <!-- Chat List -->
        <div id="chatList" class="flex-1 overflow-y-auto sidebar-scroll p-3 space-y-1">
            <!-- Chats will be populated dynamically -->
        </div>
        
        <!-- Sidebar Footer -->
        <div class="p-4 border-t border-gray-100">
            <button onclick="clearAllChats()" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 text-red-600 hover:bg-red-50 rounded-xl text-sm font-medium transition-colors touch-btn">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                <span data-i18n="clearAll">–ë–∞–∞—Ä—ã–Ω ”©—á“Ø—Ä“Ø“Ø</span>
            </button>
        </div>
    </aside>
    
    <!-- Sidebar Overlay (Mobile) -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white py-4 px-4 shadow-xl sticky top-0 z-20">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center justify-between">
                    <!-- Left: Hamburger + Logo -->
                    <div class="flex items-center gap-3">
                        <!-- Sidebar Toggle (Hamburger) -->
                        <button onclick="toggleSidebar()" class="p-2 hover:bg-white/10 rounded-xl transition-colors touch-btn" title="Toggle Sidebar">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                        
                        <!-- Logo -->
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 sm:w-11 sm:h-11 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
                                </svg>
                            </div>
                            <div class="hidden sm:block">
                                <h1 class="text-lg sm:text-xl font-extrabold tracking-tight">–ê–∫—ã–π–∫–∞—Ç AI</h1>
                                <p class="text-blue-200 text-xs sm:text-sm font-medium" data-i18n="tagline">–ê–¥–∏–ª–µ—Ç—Ç–∏–∫ –∞—Ä –±–∏—Ä”©”© “Ø—á“Ø–Ω</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Controls -->
                    <div class="flex items-center gap-2 sm:gap-4">
                        <!-- Language Toggle -->
                        <div class="toggle-switch" id="langToggle" onclick="toggleLanguage()">
                            <div class="toggle-labels">
                                <span class="toggle-label">KG</span>
                                <span class="toggle-label">RU</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 max-w-5xl mx-auto px-4 py-6 sm:py-10 w-full">
            <!-- Welcome Section (shown when no active chat) -->
            <div id="welcomeSection">
                <div class="text-center mb-8 sm:mb-10">
                    <div class="inline-flex items-center gap-2 bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-medium mb-4">
                        <span class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></span>
                        <span data-i18n="online">–û–Ω–ª–∞–π–Ω –∂–∞–Ω–∞ –∞–∫—ã—Å—ã–∑</span>
                    </div>
                    <h2 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-gray-900 mb-3 sm:mb-4 leading-tight px-2">
                        <span data-i18n="title">–ö—ã—Ä–≥—ã–∑ –†–µ—Å–ø—É–±–ª–∏–∫–∞—Å—ã–Ω—ã–Ω –º—ã–π–∑–∞–º–¥–∞—Ä—ã –±–æ—é–Ω—á–∞ —Å–∞–Ω–∞—Ä–∏–ø—Ç–∏–∫ —é—Ä–∏—Å—Ç–∏“£–∏–∑</span>
                    </h2>
                    <p class="text-gray-600 text-sm sm:text-base md:text-lg max-w-2xl mx-auto px-4" data-i18n="subtitle">
                        –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è –∂–∞–Ω–∞ –ö–† –∫–æ–¥–µ–∫—Å—Ç–µ—Ä–∏–Ω–∏–Ω –Ω–µ–≥–∏–∑–∏–Ω–¥–µ –∞–∫—ã—Å—ã–∑ —é—Ä–∏–¥–∏–∫–∞–ª—ã–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è. –ö—ã—Ä–≥—ã–∑—á–∞ –∂–µ –æ—Ä—É—Å—á–∞ —Å—É—Ä–æ–æ –±–µ—Ä–∏“£–∏–∑.
                    </p>
                </div>

                <!-- Quick Questions -->
                <div class="mb-8">
                    <h3 class="text-xs sm:text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 text-center" data-i18n="popularQuestions">
                        –ö”©–ø –±–µ—Ä–∏–ª“Ø“Ø—á“Ø —Å—É—Ä–æ–æ–ª–æ—Ä
                    </h3>
                    <div class="quick-scroll -mx-4 px-4">
                        <div class="flex gap-3 min-w-max pb-2">
                            <button onclick="setQuestion('–ë–∞–ª–∞–≥–∞ —Å“Ø–π“Ø–Ω—á“Ø –∂”©–ª”©–∫–ø—É–ª—É–Ω –∫–∞–Ω—Ç–∏–ø –∞–ª—Å–∞ –±–æ–ª–æ—Ç? –ö–∞–Ω–¥–∞–π –¥–æ–∫—É–º–µ–Ω—Ç—Ç–µ—Ä –∫–µ—Ä–µ–∫?')" 
                                    class="touch-btn group px-4 py-3 bg-white border-2 border-blue-100 rounded-2xl hover:border-blue-400 hover:shadow-lg transition-all">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">üë∂</span>
                                    <div class="text-left">
                                        <p class="font-semibold text-gray-800 text-sm" data-i18n="q1title">–ë–∞–ª–∞–≥–∞ —Å“Ø–π“Ø–Ω—á“Ø</p>
                                        <p class="text-xs text-gray-500" data-i18n="q1desc">–ñ”©–ª”©–∫–ø—É–ª –∞–ª—É—É</p>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="setQuestion('–ê–ª–∏–º–µ–Ω—Ç –∫–∞–Ω—Ç–∏–ø –∞–ª—Å–∞ –±–æ–ª–æ—Ç? –°–æ—Ç–∫–æ –∫–∞–π—Ä—ã–ª—É—É —Ç–∞—Ä—Ç–∏–±–∏ –∫–∞–Ω–¥–∞–π?')" 
                                    class="touch-btn group px-4 py-3 bg-white border-2 border-blue-100 rounded-2xl hover:border-blue-400 hover:shadow-lg transition-all">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">üë®‚Äçüë©‚Äçüëß</span>
                                    <div class="text-left">
                                        <p class="font-semibold text-gray-800 text-sm" data-i18n="q2title">–ê–ª–∏–º–µ–Ω—Ç –∞–ª—É—É</p>
                                        <p class="text-xs text-gray-500" data-i18n="q2desc">“Æ–π-–±“Ø–ª”© —É–∫—É–≥—É</p>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="setQuestion('–ú–µ–Ω–∏ –∏—à—Ç–µ–Ω –º—ã–π–∑–∞–º—Å—ã–∑ –±–æ—à–æ—Ç—É—à—Ç—É. –ú–µ–Ω–∏–Ω —É–∫—É–∫—Ç–∞—Ä—ã–º –∫–∞–Ω–¥–∞–π? –ö–∞–π–¥–∞ –∫–∞–π—Ä—ã–ª—Å–∞–º –±–æ–ª–æ—Ç?')" 
                                    class="touch-btn group px-4 py-3 bg-white border-2 border-blue-100 rounded-2xl hover:border-blue-400 hover:shadow-lg transition-all">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">‚öñÔ∏è</span>
                                    <div class="text-left">
                                        <p class="font-semibold text-gray-800 text-sm" data-i18n="q3title">–ò—à—Ç–µ–Ω –±–æ—à–æ—Ç—É—É</p>
                                        <p class="text-xs text-gray-500" data-i18n="q3desc">–≠–º–≥–µ–∫ —É–∫—É–∫—Ç–∞—Ä—ã</p>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="setQuestion('–ñ–æ–ª –∫—ã–π–º—ã–ª —ç—Ä–µ–∂–µ–ª–µ—Ä–∏–Ω –±—É–∑–≥–∞–Ω–¥—ã–∫ “Ø—á“Ø–Ω –∫–∞–Ω–¥–∞–π –∞–π—ã–ø –ø—É–ª–¥–∞—Ä –±–∞—Ä?')" 
                                    class="touch-btn group px-4 py-3 bg-white border-2 border-blue-100 rounded-2xl hover:border-blue-400 hover:shadow-lg transition-all">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">üöó</span>
                                    <div class="text-left">
                                        <p class="font-semibold text-gray-800 text-sm" data-i18n="q4title">–ñ–ö–≠ –∞–π—ã–ø—Ç–∞—Ä—ã</p>
                                        <p class="text-xs text-gray-500" data-i18n="q4desc">–ñ–æ–ª —ç—Ä–µ–∂–µ–ª–µ—Ä–∏</p>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="setQuestion('–ñ–ß–ö –∂–µ –ò–ü –∫–∞–Ω—Ç–∏–ø –∫–∞—Ç—Ç–∞—Å–∞ –±–æ–ª–æ—Ç? –ö–∞–Ω–¥–∞–π –∫–∞–¥–∞–º–¥–∞—Ä –∫–µ—Ä–µ–∫?')" 
                                    class="touch-btn group px-4 py-3 bg-white border-2 border-blue-100 rounded-2xl hover:border-blue-400 hover:shadow-lg transition-all">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">üìã</span>
                                    <div class="text-left">
                                        <p class="font-semibold text-gray-800 text-sm" data-i18n="q5title">–ë–∏–∑–Ω–µ—Å –∫–∞—Ç—Ç–æ–æ</p>
                                        <p class="text-xs text-gray-500" data-i18n="q5desc">–ñ–ß–ö / –ò–ü</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div id="chatMessages" class="space-y-4 mb-6 hidden">
                <!-- Messages will be populated here -->
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="bg-white rounded-3xl shadow-xl border border-gray-100 p-6 sm:p-8 hidden mb-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="loader-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <div>
                        <p class="text-gray-700 font-semibold" data-i18n="analyzing">–ö–† –º—ã–π–∑–∞–º–¥–∞—Ä—ã–Ω —Ç–∞–ª–¥–æ–æ–¥–æ...</p>
                        <p class="text-gray-400 text-sm" data-i18n="wait">–ë–∏—Ä –∞–∑ –∫“Ø—Ç”© —Ç—É—Ä—É“£—É–∑</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="skeleton h-4 w-full"></div>
                    <div class="skeleton h-4 w-11/12"></div>
                    <div class="skeleton h-4 w-4/5"></div>
                    <div class="skeleton h-4 w-9/12"></div>
                </div>
            </div>

            <!-- Question Input -->
            <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
                <div class="p-5 sm:p-6">
                    <textarea 
                        id="question" 
                        rows="3" 
                        class="w-full px-4 py-4 border-2 border-gray-200 rounded-2xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all resize-none text-gray-800 placeholder-gray-400 text-base"
                        data-i18n-placeholder="inputPlaceholder"
                        placeholder="–ú–∏—Å–∞–ª—ã: –ò—à –±–µ—Ä“Ø“Ø—á“Ø–º –∞–π–ª—ã–≥—ã–º–¥—ã 2 –∞–π–¥–∞–Ω –±–µ—Ä–∏ –±–µ—Ä–±–µ–π –∂–∞—Ç–∞—Ç. –ú–µ–Ω —ç–º–Ω–µ –∫—ã–ª—Å–∞–º –±–æ–ª–æ—Ç?"
                    ></textarea>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mt-4">
                        <div class="flex items-center gap-2 text-xs text-gray-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                            <span data-i18n="privacy">–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä—ã“£—ã–∑ —Å–∞–∫—Ç–∞–ª–±–∞–π—Ç</span>
                        </div>
                        <button 
                            onclick="askQuestion()" 
                            id="askButton"
                            class="touch-btn w-full sm:w-auto gradient-btn text-white font-bold rounded-2xl px-8 py-4 shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
                        >
                            <span data-i18n="submitBtn">–ñ”©–Ω”©—Ç“Ø“Ø</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 py-4 px-4 mt-auto">
            <div class="max-w-5xl mx-auto text-center">
                <div class="flex items-center justify-center gap-2 mb-1">
                    <span class="text-xl">üá∞üá¨</span>
                    <p class="text-gray-600 text-sm font-medium" data-i18n="footerTitle">
                        –ê–∫—ã–π–∫–∞—Ç AI ‚Äî –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–¥—ã–Ω –∂–∞—Ä–∞–Ω–¥–∞—Ä—ã “Ø—á“Ø–Ω –¥–æ–ª–±–æ–æ—Ä
                    </p>
                </div>
                <p class="text-gray-400 text-xs" data-i18n="footerDisclaimer">
                    –ú–∞–∞–ª—ã–º–∞—Ç –º–∞–∞–ª—ã–º–¥–∞–º–∞ –º“Ø–Ω”©–∑“Ø–Ω–¥”© –±–µ—Ä–∏–ª–µ—Ç. –Æ—Ä–∏–¥–∏–∫–∞–ª—ã–∫ –º–∞–∞–Ω–∏–ª“Ø“Ø –∞—Ä–∞–∫–µ—Ç—Ç–µ—Ä “Ø—á“Ø–Ω –∞–¥–≤–æ–∫–∞—Ç–∫–∞ –∫–∞–π—Ä—ã–ª—ã“£—ã–∑.
                </p>
            </div>
        </footer>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-2xl shadow-xl z-50 hidden text-sm font-medium">
        <span id="toastText"></span>
    </div>

    <script>
        // ========== CONFIG ==========
        const DEFAULT_API_KEY = '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';
        const MODEL = 'tngtech/deepseek-r1t-chimera:free';
        const CHATS_STORAGE_KEY = 'akyykat_chats';
        const ACTIVE_CHAT_KEY = 'akyykat_active_chat';
        
        // ========== i18n TRANSLATIONS ==========
        const translations = {
            ky: {
                tagline: "–ê–¥–∏–ª–µ—Ç—Ç–∏–∫ –∞—Ä –±–∏—Ä”©”© “Ø—á“Ø–Ω",
                chatHistory: "–ß–∞—Ç—Ç–∞—Ä —Ç–∞—Ä—ã—Ö—ã",
                newChat: "–ñ–∞“£—ã —á–∞—Ç",
                noChats: "–ß–∞—Ç—Ç–∞—Ä –∂–æ–∫",
                startFirst: "–ë–∏—Ä–∏–Ω—á–∏ —Å—É—Ä–æ–æ–Ω—É –±–µ—Ä–∏“£–∏–∑",
                clearAll: "–ë–∞–∞—Ä—ã–Ω ”©—á“Ø—Ä“Ø“Ø",
                online: "–û–Ω–ª–∞–π–Ω –∂–∞–Ω–∞ –∞–∫—ã—Å—ã–∑",
                title: "–ö—ã—Ä–≥—ã–∑ –†–µ—Å–ø—É–±–ª–∏–∫–∞—Å—ã–Ω—ã–Ω –º—ã–π–∑–∞–º–¥–∞—Ä—ã –±–æ—é–Ω—á–∞ —Å–∞–Ω–∞—Ä–∏–ø—Ç–∏–∫ —é—Ä–∏—Å—Ç–∏“£–∏–∑",
                subtitle: "–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è –∂–∞–Ω–∞ –ö–† –∫–æ–¥–µ–∫—Å—Ç–µ—Ä–∏–Ω–∏–Ω –Ω–µ–≥–∏–∑–∏–Ω–¥–µ –∞–∫—ã—Å—ã–∑ —é—Ä–∏–¥–∏–∫–∞–ª—ã–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è. –ö—ã—Ä–≥—ã–∑—á–∞ –∂–µ –æ—Ä—É—Å—á–∞ —Å—É—Ä–æ–æ –±–µ—Ä–∏“£–∏–∑.",
                popularQuestions: "–ö”©–ø –±–µ—Ä–∏–ª“Ø“Ø—á“Ø —Å—É—Ä–æ–æ–ª–æ—Ä",
                q1title: "–ë–∞–ª–∞–≥–∞ —Å“Ø–π“Ø–Ω—á“Ø",
                q1desc: "–ñ”©–ª”©–∫–ø—É–ª –∞–ª—É—É",
                q2title: "–ê–ª–∏–º–µ–Ω—Ç –∞–ª—É—É",
                q2desc: "“Æ–π-–±“Ø–ª”© —É–∫—É–≥—É",
                q3title: "–ò—à—Ç–µ–Ω –±–æ—à–æ—Ç—É—É",
                q3desc: "–≠–º–≥–µ–∫ —É–∫—É–∫—Ç–∞—Ä—ã",
                q4title: "–ñ–ö–≠ –∞–π—ã–ø—Ç–∞—Ä—ã",
                q4desc: "–ñ–æ–ª —ç—Ä–µ–∂–µ–ª–µ—Ä–∏",
                q5title: "–ë–∏–∑–Ω–µ—Å –∫–∞—Ç—Ç–æ–æ",
                q5desc: "–ñ–ß–ö / –ò–ü",
                inputPlaceholder: "–ú–∏—Å–∞–ª—ã: –ò—à –±–µ—Ä“Ø“Ø—á“Ø–º –∞–π–ª—ã–≥—ã–º–¥—ã 2 –∞–π–¥–∞–Ω –±–µ—Ä–∏ –±–µ—Ä–±–µ–π –∂–∞—Ç–∞—Ç. –ú–µ–Ω —ç–º–Ω–µ –∫—ã–ª—Å–∞–º –±–æ–ª–æ—Ç?",
                privacy: "–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä—ã“£—ã–∑ —Å–∞–∫—Ç–∞–ª–±–∞–π—Ç",
                submitBtn: "–ñ”©–Ω”©—Ç“Ø“Ø",
                analyzing: "–ö–† –º—ã–π–∑–∞–º–¥–∞—Ä—ã–Ω —Ç–∞–ª–¥–æ–æ–¥–æ...",
                wait: "–ë–∏—Ä –∞–∑ –∫“Ø—Ç”© —Ç—É—Ä—É“£—É–∑",
                footerTitle: "–ê–∫—ã–π–∫–∞—Ç AI ‚Äî –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–¥—ã–Ω –∂–∞—Ä–∞–Ω–¥–∞—Ä—ã “Ø—á“Ø–Ω –¥–æ–ª–±–æ–æ—Ä",
                footerDisclaimer: "–ú–∞–∞–ª—ã–º–∞—Ç –º–∞–∞–ª—ã–º–¥–∞–º–∞ –º“Ø–Ω”©–∑“Ø–Ω–¥”© –±–µ—Ä–∏–ª–µ—Ç. –Æ—Ä–∏–¥–∏–∫–∞–ª—ã–∫ –º–∞–∞–Ω–∏–ª“Ø“Ø –∞—Ä–∞–∫–µ—Ç—Ç–µ—Ä “Ø—á“Ø–Ω –∞–¥–≤–æ–∫–∞—Ç–∫–∞ –∫–∞–π—Ä—ã–ª—ã“£—ã–∑.",
                apiModalTitle: "API –∂”©–Ω–¥”©”©–ª”©—Ä“Ø",
                apiModalDesc: "API –∞—á–∫—ã—á—ã –¥–µ–º–µ–π–∫–∏ –±–æ—é–Ω—á–∞ –æ—Ä–Ω–æ—Ç—É–ª–≥–∞–Ω. ”®–∑“Ø“£“Ø–∑–¥“Ø–Ω OpenRouter.ai –∞—á–∫—ã—á—ã“£—ã–∑–¥—ã –∫–æ–ª–¥–æ–Ω—Å–æ“£—É–∑ –±–æ–ª–æ—Ç.",
                defaultBtn: "–î–µ–º–µ–π–∫–∏",
                saveBtn: "–°–∞–∫—Ç–æ–æ",
                apiSecurityNote: "üîí –ê—á–∫—ã—á —Å–∏–∑–¥–∏–Ω –±—Ä–∞—É–∑–µ—Ä–∏“£–∏–∑–¥–µ –≥–∞–Ω–∞ —Å–∞–∫—Ç–∞–ª–∞—Ç",
                toastCopied: "–ö”©—á“Ø—Ä“Ø–ª–¥“Ø",
                toastCleared: "–ß–∞—Ç—Ç–∞—Ä ”©—á“Ø—Ä“Ø–ª–¥“Ø",

                toastEmpty: "–°—É—Ä–æ–æ–Ω—É –∂–∞–∑—ã“£—ã–∑",
                toastNewChat: "–ñ–∞“£—ã —á–∞—Ç –±–∞—à—Ç–∞–ª–¥—ã",
                langKy: "üá∞üá¨ –ö—ã—Ä–≥—ã–∑—á–∞",
                langRu: "üá∑üá∫ –û—Ä—É—Å—á–∞",
                you: "–°–∏–∑",
                deleteChat: "–ß–∞—Ç—Ç—ã ”©—á“Ø—Ä“Ø“Ø",
                today: "–ë“Ø–≥“Ø–Ω",
                yesterday: "–ö–µ—á—ç—ç",
                confirmClearAll: "–ë–∞—Ä–¥—ã–∫ —á–∞—Ç—Ç–∞—Ä–¥—ã ”©—á“Ø—Ä“Ø“Ø?",
                errorTitle: "–ö–∞—Ç–∞",
                errorNetwork: "–¢–∞—Ä–º–∞–∫ –∫–∞—Ç–∞—Å—ã. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç—Ç–∏ —Ç–µ–∫—à–µ—Ä–∏“£–∏–∑.",
                errorApi: "API –∫–∞—Ç–∞—Å—ã"
            },
            ru: {
                tagline: "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ",
                chatHistory: "–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤",
                newChat: "–ù–æ–≤—ã–π —á–∞—Ç",
                noChats: "–ù–µ—Ç —á–∞—Ç–æ–≤",
                startFirst: "–ó–∞–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å",
                clearAll: "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ",
                online: "–û–Ω–ª–∞–π–Ω –∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ",
                title: "–í–∞—à —Ü–∏—Ñ—Ä–æ–≤–æ–π —é—Ä–∏—Å—Ç –ø–æ –∑–∞–∫–æ–Ω–∞–º –ö—ã—Ä–≥—ã–∑—Å–∫–æ–π –†–µ—Å–ø—É–±–ª–∏–∫–∏",
                subtitle: "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–∏ –∏ –∫–æ–¥–µ–∫—Å–æ–≤ –ö–†. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –Ω–∞ –∫—ã—Ä–≥—ã–∑—Å–∫–æ–º –∏–ª–∏ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.",
                popularQuestions: "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã",
                q1title: "–ë–∞–ª–∞–≥–∞ —Å“Ø–π“Ø–Ω—á“Ø",
                q1desc: "–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–æ–±–∏—è",
                q2title: "–ê–ª–∏–º–µ–Ω—Ç—ã",
                q2desc: "–°–µ–º–µ–π–Ω–æ–µ –ø—Ä–∞–≤–æ",
                q3title: "–£–≤–æ–ª—å–Ω–µ–Ω–∏–µ",
                q3desc: "–¢—Ä—É–¥–æ–≤—ã–µ –ø—Ä–∞–≤–∞",
                q4title: "–®—Ç—Ä–∞—Ñ—ã –ü–î–î",
                q4desc: "–ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Ä–æ–∂–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è",
                q5title: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å–∞",
                q5desc: "–û–û–û / –ò–ü",
                inputPlaceholder: "–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å –Ω–µ –ø–ª–∞—Ç–∏—Ç –∑–∞—Ä–ø–ª–∞—Ç—É —É–∂–µ 2 –º–µ—Å—è—Ü–∞. –ß—Ç–æ –º–Ω–µ –¥–µ–ª–∞—Ç—å?",
                privacy: "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è",
                submitBtn: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
                analyzing: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–∫–æ–Ω—ã –ö–†...",
                wait: "–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ",
                footerTitle: "–ê–∫—ã–π–∫–∞—Ç AI ‚Äî –ø—Ä–æ–µ–∫—Ç –¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞",
                footerDisclaimer: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–≤–æ–∫–∞—Ç—É.",
                apiModalTitle: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API",
                apiModalDesc: "API-–∫–ª—é—á —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –∫–ª—é—á –æ—Ç OpenRouter.ai.",
                defaultBtn: "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é",
                saveBtn: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
                apiSecurityNote: "üîí –ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ",
                toastCopied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ",
                toastCleared: "–ß–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã",

                toastEmpty: "–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å",
                toastNewChat: "–ù–æ–≤—ã–π —á–∞—Ç —Å–æ–∑–¥–∞–Ω",
                langKy: "üá∞üá¨ –ö—ã—Ä–≥—ã–∑—á–∞",
                langRu: "üá∑üá∫ –†—É—Å—Å–∫–∏–π",
                you: "–í—ã",
                deleteChat: "–£–¥–∞–ª–∏—Ç—å —á–∞—Ç",
                today: "–°–µ–≥–æ–¥–Ω—è",
                yesterday: "–í—á–µ—Ä–∞",
                confirmClearAll: "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã?",
                errorTitle: "–û—à–∏–±–∫–∞",
                errorNetwork: "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.",
                errorApi: "–û—à–∏–±–∫–∞ API"
            }
        };
        
        // ========== SYSTEM PROMPT ==========
        const SYSTEM_PROMPT = `–°–µ–Ω ‚Äî –ê–∫—ã–π–∫–∞—Ç AI, –ö—ã—Ä–≥—ã–∑ –†–µ—Å–ø—É–±–ª–∏–∫–∞—Å—ã–Ω—ã–Ω —É–∫—É–∫ –±–æ—é–Ω—á–∞ —ç–∫—Å–ø–µ—Ä—Ç–∏.
–¢—ã ‚Äî –ê–∫—ã–π–∫–∞—Ç AI, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–∞–≤—É –ö—ã—Ä–≥—ã–∑—Å–∫–æ–π –†–µ—Å–ø—É–±–ª–∏–∫–∏.

üìö –ë–ò–õ–ò–ú –ë–ê–ó–ê–°–´ / –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô:
- –ö—ã—Ä–≥—ã–∑ –†–µ—Å–ø—É–±–ª–∏–∫–∞—Å—ã–Ω—ã–Ω –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è—Å—ã / –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è –ö–†
- –ñ–∞—Ä–∞–Ω–¥—ã–∫ –∫–æ–¥–µ–∫—Å–∏ / –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –∫–æ–¥–µ–∫—Å –ö–†
- –≠–º–≥–µ–∫ –∫–æ–¥–µ–∫—Å–∏ / –¢—Ä—É–¥–æ–≤–æ–π –∫–æ–¥–µ–∫—Å –ö–†  
- “Æ–π-–±“Ø–ª”© –∫–æ–¥–µ–∫—Å–∏ / –°–µ–º–µ–π–Ω—ã–π –∫–æ–¥–µ–∫—Å –ö–†
- –ñ–∞–∑—ã–∫ –∫–æ–¥–µ–∫—Å–∏ / –£–≥–æ–ª–æ–≤–Ω—ã–π –∫–æ–¥–µ–∫—Å –ö–†
- –£–∫—É–∫ –±—É–∑—É—É–ª–∞—Ä –∂”©–Ω“Ø–Ω–¥”© –∫–æ–¥–µ–∫—Å / –ö–æ–¥–µ–∫—Å –æ –ø—Ä–∞–≤–æ–Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö –ö–†
- –°–∞–ª—ã–∫ –∫–æ–¥–µ–∫—Å–∏ / –ù–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–¥–µ–∫—Å –ö–†
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–¥–∏–∫ –º—ã–π–∑–∞–º–¥–∞—Ä / –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–æ–Ω—ã

‚ö†Ô∏è –ö–ê–¢–£–£ –§–ò–õ–¨–¢–† / –°–¢–†–û–ì–ò–ô –§–ò–õ–¨–¢–†:
–≠–≥–µ—Ä–¥–µ —Å—É—Ä–æ–æ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–¥—ã–Ω –º—ã–π–∑–∞–º–¥–∞—Ä—ã–Ω–∞ –¢–ò–ï–®–ï–°–ò –ñ–û–ö–°–ê (–º–∏—Å–∞–ª—ã: —Ç–∞–º–∞–∫ –∂–∞—Å–æ–æ, –±–∞—à–∫–∞ ”©–ª–∫”©–ª”©—Ä–¥“Ø–Ω –º—ã–π–∑–∞–º–¥–∞—Ä—ã, –ø—Ä–æ–≥—Ä–∞–º–º–∞–ª–æ–æ, –æ–π—É–Ω-–∑–æ–æ–∫ –∂.–±.), –∞–Ω–¥–∞ –ú–ò–õ–î–ï–¢–¢“Æ“Æ —Ç“Ø—Ä–¥”© –±–∞—à —Ç–∞—Ä—Ç:

–ö—ã—Ä–≥—ã–∑—á–∞ –∂–æ–æ–ø: "–ö–µ—á–∏—Ä–∏“£–∏–∑, –º–µ–Ω –±–∏—Ä –≥–∞–Ω–∞ –ö—ã—Ä–≥—ã–∑ –†–µ—Å–ø—É–±–ª–∏–∫–∞—Å—ã–Ω—ã–Ω –º—ã–π–∑–∞–º–¥–∞—Ä—ã –±–æ—é–Ω—á–∞ –∂–∞—Ä–¥–∞–º –±–µ—Ä–µ–º. –Æ—Ä–∏–¥–∏–∫–∞–ª—ã–∫ —Å—É—Ä–æ–æ –±–µ—Ä—Å–µ“£–∏–∑, –∫—É–±–∞–Ω—ã—á –º–µ–Ω–µ–Ω –∂–∞—Ä–¥–∞–º –±–µ—Ä–µ–º!"

–†—É—Å—Å–∫–∏–π –æ—Ç–≤–µ—Ç: "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø–æ–º–æ–≥–∞—é —Ç–æ–ª—å–∫–æ –ø–æ –∑–∞–∫–æ–Ω–∞–º –ö—ã—Ä–≥—ã–∑—Å–∫–æ–π –†–µ—Å–ø—É–±–ª–∏–∫–∏. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å ‚Äî —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–º–æ–≥—É!"

üìå –ñ–û–û–ü –ë–ï–†“Æ“Æ –≠–†–ï–ñ–ï–õ–ï–†–ò / –ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–û–í:

1. –¢–ò–õ–î–ò –ê–ù–´–ö–¢–ê / –û–ü–†–ï–î–ï–õ–ò –Ø–ó–´–ö:
   - –°—É—Ä–æ–æ –∫—ã—Ä–≥—ã–∑—á–∞ –±–æ–ª—Å–æ ‚Üí –∫—ã—Ä–≥—ã–∑—á–∞ –∂–æ–æ–ø –±–µ—Ä
   - –í–æ–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º ‚Üí –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º

2. –ö–´–†–ì–´–ó–ß–ê –ñ–û–û–ü –ë–ï–†“Æ“Æ–î”®:
   - –Æ—Ä–∏–¥–∏–∫–∞–ª—ã–∫ —Ç–µ—Ä–º–∏–Ω–¥–µ—Ä–¥–∏ –∫–æ–ª–¥–æ–Ω: —á–µ–Ω–µ–º–¥–∏–∫ —É–∫—É–∫—Ç—É–∫ –∞–∫—Ç—ã–ª–∞—Ä, —Ç–æ–∫—Ç–æ–º, –±–µ—Ä–µ–Ω–µ, —É–∫—É–∫ —Å—É–±—ä–µ–∫—Ç–∏—Å–∏
   - –ö–æ–¥–µ–∫—Å—Ç–µ—Ä–≥–µ —à–∏–ª—Ç–µ–º–µ –±–µ—Ä: "–ö–† –≠–º–≥–µ–∫ –∫–æ–¥–µ–∫—Å–∏–Ω–∏–Ω 150-–±–µ—Ä–µ–Ω–µ—Å–∏–Ω–µ —ã–ª–∞–π—ã–∫..."
   - –ö–∞–¥–∞–º-–∫–∞–¥–∞–º –ø–ª–∞–Ω –±–µ—Ä

3. –ü–†–ò –û–¢–í–ï–¢–ï –ù–ê –†–£–°–°–ö–û–ú:
   - –ò—Å–ø–æ–ª—å–∑—É–π —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é: –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ-–ø—Ä–∞–≤–æ–≤—ã–µ –∞–∫—Ç—ã, –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, —Å—Ç–∞—Ç—å—è
   - –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –∫–æ–¥–µ–∫—Å—ã: "–°–æ–≥–ª–∞—Å–Ω–æ —Å—Ç. 150 –¢—Ä—É–¥–æ–≤–æ–≥–æ –∫–æ–¥–µ–∫—Å–∞ –ö–†..."
   - –î–∞–≤–∞–π –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

4. –§–û–†–ú–ê–¢ –ñ–û–û–ü / –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
   - –ö—ã—Å–∫–∞—á–∞ –∂–∞–Ω–∞ —Ç–∞–∫ –±–æ–ª / –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ —Ç–æ—á–Ω—ã–º
   - –ö–æ–Ω–∫—Ä–µ—Ç—Ç“Ø“Ø –±–µ—Ä–µ–Ω–µ–ª–µ—Ä–≥–µ —à–∏–ª—Ç–µ–º–µ –±–µ—Ä / –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏
   - –ü—Ä–∞–∫—Ç–∏–∫–∞–ª—ã–∫ –∫–µ“£–µ—à –±–µ—Ä / –î–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã

5. ‚ö†Ô∏è –î–ò–°–ö–õ–ï–ô–ú–ï–† (–∞—Ä –±–∏—Ä –∂–æ–æ–ø—Ç—É–Ω –∞—è–≥—ã–Ω–¥–∞ / –≤ –∫–æ–Ω—Ü–µ –ö–ê–ñ–î–û–ì–û –æ—Ç–≤–µ—Ç–∞):

–ö—ã—Ä–≥—ã–∑—á–∞: "---\\nüìã **–ú–∞–∞–Ω–∏–ª“Ø“Ø:** –ë—É–ª –º–∞–∞–ª—ã–º–∞—Ç —Ç–∞–∞–Ω—ã—à—É—É “Ø—á“Ø–Ω –≥–∞–Ω–∞ –±–µ—Ä–∏–ª–¥–∏. –Æ—Ä–∏–¥–∏–∫–∞–ª—ã–∫ –º–∞–∞–Ω–∏–ª“Ø“Ø –∞—Ä–∞–∫–µ—Ç—Ç–µ—Ä “Ø—á“Ø–Ω –∞–¥–≤–æ–∫–∞—Ç–∫–∞ –∫–∞–π—Ä—ã–ª—É—É–Ω—É —Å—É–Ω—É—à—Ç–∞–π–±—ã–∑."

–†—É—Å—Å–∫–∏–π: "---\\nüìã **–í–∞–∂–Ω–æ:** –î–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö. –î–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–≤–æ–∫–∞—Ç—É."`;

        // ========== STATE ==========
        let currentLang = localStorage.getItem('akyykat_lang') || 'ky';
        let chats = [];
        let activeChatId = null;
        let sidebarOpen = window.innerWidth >= 1024;
        
        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Load chats from localStorage
            loadChats();
            
            // Apply saved language
            applyLanguage(currentLang);
            
            // Update toggle state
            updateToggleState();
            
            // Initialize sidebar state
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.remove('open');
            }
        });
        
        // ========== CHAT STORAGE FUNCTIONS ==========
        function loadChats() {
            const stored = localStorage.getItem(CHATS_STORAGE_KEY);
            chats = stored ? JSON.parse(stored) : [];
            
            const storedActiveId = localStorage.getItem(ACTIVE_CHAT_KEY);
            if (storedActiveId && chats.find(c => c.id === storedActiveId)) {
                activeChatId = storedActiveId;
                loadChat(activeChatId);
            }
            
            renderChatList();
        }
        
        function saveChats() {
            localStorage.setItem(CHATS_STORAGE_KEY, JSON.stringify(chats));
            if (activeChatId) {
                localStorage.setItem(ACTIVE_CHAT_KEY, activeChatId);
            } else {
                localStorage.removeItem(ACTIVE_CHAT_KEY);
            }
        }
        
        function createChat(firstMessage) {
            const chat = {
                id: Date.now().toString(),
                title: firstMessage.substring(0, 40) + (firstMessage.length > 40 ? '...' : ''),
                createdAt: new Date().toISOString(),
                messages: []
            };
            chats.unshift(chat);
            activeChatId = chat.id;
            saveChats();
            renderChatList();
            return chat;
        }
        
        function getActiveChat() {
            return chats.find(c => c.id === activeChatId);
        }
        
        function addMessageToChat(role, content) {
            const chat = getActiveChat();
            if (chat) {
                chat.messages.push({
                    role,
                    content,
                    timestamp: new Date().toISOString()
                });
                saveChats();
            }
        }
        
        function renderChatList() {
            const chatList = document.getElementById('chatList');
            if (!chatList) return; // Safety check
            
            const t = translations[currentLang];
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (chats.length === 0) {
                chatList.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        <p class="text-sm">${t.noChats}</p>
                        <p class="text-xs mt-1">${t.startFirst}</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            chats.forEach(chat => {
                const chatDate = new Date(chat.createdAt).toDateString();
                let dateLabel = '';
                if (chatDate === today) {
                    dateLabel = t.today;
                } else if (chatDate === yesterday) {
                    dateLabel = t.yesterday;
                } else {
                    dateLabel = new Date(chat.createdAt).toLocaleDateString();
                }
                
                const isActive = chat.id === activeChatId;
                
                html += `
                    <div class="chat-item ${isActive ? 'active' : ''} p-3 rounded-xl cursor-pointer group" onclick="loadChat('${chat.id}')">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-gray-800 text-sm truncate">${escapeHtml(chat.title)}</p>
                                <p class="text-xs text-gray-400 mt-1">${dateLabel}</p>
                            </div>
                            <button onclick="event.stopPropagation(); deleteChat('${chat.id}')" 
                                    class="opacity-0 group-hover:opacity-100 sm:opacity-0 max-sm:opacity-60 p-1.5 hover:bg-red-100 rounded-lg transition-all touch-btn"
                                    title="${t.deleteChat}">
                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            chatList.innerHTML = html;
        }
        
        function loadChat(chatId) {
            activeChatId = chatId;
            saveChats();
            
            const chat = getActiveChat();
            if (!chat) return;
            
            // Hide welcome, show messages
            document.getElementById('welcomeSection').classList.add('hidden');
            document.getElementById('chatMessages').classList.remove('hidden');
            
            // Render messages
            renderMessages(chat.messages);
            
            // Update sidebar
            renderChatList();
            
            // Close sidebar on mobile
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }
        
        function renderMessages(messages) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            const t = translations[currentLang];
            
            let html = '';
            
            messages.forEach(msg => {
                if (msg.role === 'user') {
                    html += `
                        <div class="flex justify-end fade-in">
                            <div class="user-message max-w-[85%] sm:max-w-[75%] rounded-2xl rounded-tr-md px-5 py-4 text-white shadow-lg">
                                <p class="text-xs font-semibold opacity-80 mb-1">${t.you}</p>
                                <p class="text-sm sm:text-base">${escapeHtml(msg.content)}</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Clean message content from any think tags (in case old data has them)
                    const cleanContent = filterThinkingTags(msg.content);
                    const lang = detectResponseLanguage(cleanContent);
                    html += `
                        <div class="flex justify-start fade-in">
                            <div class="ai-message max-w-[90%] sm:max-w-[80%] rounded-2xl rounded-tl-md px-5 py-4 shadow-lg">
                                <div class="flex items-center gap-2 mb-3">
                                    <div class="w-7 h-7 gradient-bg rounded-lg flex items-center justify-center">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
                                        </svg>
                                    </div>
                                    <span class="font-bold text-blue-900 text-sm">–ê–∫—ã–π–∫–∞—Ç AI</span>
                                    <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full">${lang.label}</span>
                                </div>
                                <div class="response-text text-gray-700 text-sm sm:text-base">${formatMarkdown(cleanContent)}</div>
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        
        function startNewChat() {
            activeChatId = null;
            saveChats();
            
            // Show welcome, hide messages
            document.getElementById('welcomeSection').classList.remove('hidden');
            document.getElementById('chatMessages').classList.add('hidden');
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('question').value = '';
            
            renderChatList();
            showToast(translations[currentLang].toastNewChat);
            
            // Close sidebar on mobile
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }
        
        function deleteChat(chatId) {
            chats = chats.filter(c => c.id !== chatId);
            
            if (activeChatId === chatId) {
                activeChatId = null;
                document.getElementById('welcomeSection').classList.remove('hidden');
                document.getElementById('chatMessages').classList.add('hidden');
            }
            
            saveChats();
            renderChatList();
        }
        
        function clearAllChats() {
            if (!confirm(translations[currentLang].confirmClearAll)) return;
            
            chats = [];
            activeChatId = null;
            saveChats();
            renderChatList();
            
            document.getElementById('welcomeSection').classList.remove('hidden');
            document.getElementById('chatMessages').classList.add('hidden');
            
            showToast(translations[currentLang].toastCleared);
        }
        
        // ========== SIDEBAR ==========
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth >= 1024) {
                sidebar.classList.toggle('desktop-closed');
            } else {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('hidden');
                document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
            }
        }
        
        // ========== LANGUAGE FUNCTIONS ==========
        function applyLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('akyykat_lang', lang);
            document.documentElement.lang = lang;
            
            const t = translations[lang];
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });
            
            document.title = lang === 'ky' 
                ? '–ê–∫—ã–π–∫–∞—Ç AI ‚Äî –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–¥—ã–Ω —Å–∞–Ω–∞—Ä–∏–ø—Ç–∏–∫ —é—Ä–∏—Å—Ç–∏'
                : '–ê–∫—ã–π–∫–∞—Ç AI ‚Äî –¶–∏—Ñ—Ä–æ–≤–æ–π —é—Ä–∏—Å—Ç –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞';
            
            // Re-render chat list with new language
            renderChatList();
            
            // Re-render messages if any
            const chat = getActiveChat();
            if (chat) {
                renderMessages(chat.messages);
            }
        }
        
        function toggleLanguage() {
            const newLang = currentLang === 'ky' ? 'ru' : 'ky';
            setLanguage(newLang);
        }
        
        function setLanguage(lang) {
            applyLanguage(lang);
            updateToggleState();
        }
        
        function updateToggleState() {
            const toggle = document.getElementById('langToggle');
            if (currentLang === 'ru') {
                toggle?.classList.add('ru');
            } else {
                toggle?.classList.remove('ru');
            }
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function setQuestion(text) {
            document.getElementById('question').value = text;
            document.getElementById('question').focus();
        }
        
        function detectResponseLanguage(text) {
            const kyrgyzChars = /[”©“Ø“£“Æ“¢”®]/i;
            const kyrgyzWords = /\b(–º–µ–Ω–∏–Ω|—Å–µ–Ω–∏–Ω|–∞–Ω—ã–Ω|–±–æ–ª–æ—Ç|—ç–º–µ—Å|–∫–µ—Ä–µ–∫|“Ø—á“Ø–Ω|–º–µ–Ω–µ–Ω|–∂–∞–Ω–∞|–±–∏—Ä–æ–∫|–∫–æ–¥–µ–∫—Å–∏|–±–µ—Ä–µ–Ω–µ—Å–∏|—ã–ª–∞–π—ã–∫|—É–∫—É–∫|–º—ã–π–∑–∞–º)\b/i;
            
            if (kyrgyzChars.test(text) || kyrgyzWords.test(text)) {
                return { code: 'ky', label: translations[currentLang].langKy };
            }
            return { code: 'ru', label: translations[currentLang].langRu };
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastText = document.getElementById('toastText');
            toastText.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2500);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function filterThinkingTags(text) {
            if (!text) return '';
            
            let cleaned = text;
            
            // ===== AGGRESSIVE THINK TAG REMOVAL =====
            
            // 1. Standard <think>...</think> (greedy - captures everything between)
            cleaned = cleaned.replace(/<think>[\s\S]*?<\/think>/gi, '');
            
            // 2. With any whitespace variations
            cleaned = cleaned.replace(/<\s*think\s*>[\s\S]*?<\s*\/\s*think\s*>/gi, '');
            
            // 3. Unclosed <think> - remove from <think> to end of string
            cleaned = cleaned.replace(/<think>[\s\S]*/gi, '');
            
            // 4. Just opening tag anywhere
            cleaned = cleaned.replace(/<think>/gi, '');
            
            // 5. Just closing tag anywhere  
            cleaned = cleaned.replace(/<\/think>/gi, '');
            
            // 6. With attributes like <think reasoning="...">
            cleaned = cleaned.replace(/<think[^>]*>[\s\S]*?<\/think>/gi, '');
            
            // 7. Self-closing think tags
            cleaned = cleaned.replace(/<think[^>]*\/>/gi, '');
            
            // 8. HTML encoded versions
            cleaned = cleaned.replace(/&lt;think&gt;[\s\S]*?&lt;\/think&gt;/gi, '');
            cleaned = cleaned.replace(/&lt;think&gt;/gi, '');
            cleaned = cleaned.replace(/&lt;\/think&gt;/gi, '');
            
            // ===== CLEAN UP =====
            
            // Remove multiple consecutive newlines (more than 2)
            cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
            
            // Remove leading/trailing whitespace and newlines
            cleaned = cleaned.trim();
            
            // If after all cleaning the text starts with common thinking patterns, remove first paragraph
            if (cleaned.match(/^(Okay|–•–æ—Ä–æ—à–æ|–î–∞–≤–∞–π|Let me|I need to|I should|First,|–°–Ω–∞—á–∞–ª–∞|–ú–Ω–µ –Ω—É–∂–Ω–æ)/i)) {
                const firstDoubleNewline = cleaned.indexOf('\n\n');
                if (firstDoubleNewline > 0 && firstDoubleNewline < 200) {
                    cleaned = cleaned.substring(firstDoubleNewline + 2).trim();
                }
            }
            
            return cleaned;
        }
        
        function formatMarkdown(text) {
            if (!text) return '';
            
            // ===== CRITICAL: Filter out ALL thinking tags before rendering =====
            // Apply main filter
            text = filterThinkingTags(text);
            
            // Additional safety: remove any remaining think patterns
            text = text.replace(/<think[\s\S]*?<\/think>/gi, '');
            text = text.replace(/<think>[\s\S]*/gi, '');
            text = text.replace(/<\/?think[^>]*>/gi, '');
            
            // Escape HTML FIRST to prevent XSS, but preserve our formatting
            let escaped = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Remove escaped think tags
            escaped = escaped.replace(/&lt;think&gt;[\s\S]*?&lt;\/think&gt;/gi, '');
            escaped = escaped.replace(/&lt;think&gt;[\s\S]*/gi, '');
            escaped = escaped.replace(/&lt;\/?think[^&]*&gt;/gi, '');
            
            // Now apply markdown formatting
            return escaped
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 p-4 rounded-xl overflow-x-auto my-4 text-sm"><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^#### (.*$)/gm, '<h4 class="font-bold text-base text-blue-900 mt-4 mb-2">$1</h4>')
                .replace(/^### (.*$)/gm, '<h3 class="font-bold text-lg text-blue-900 mt-5 mb-2">$1</h3>')
                .replace(/^## (.*$)/gm, '<h3 class="font-bold text-xl text-blue-900 mt-6 mb-3">$1</h3>')
                .replace(/^&gt; (.*$)/gm, '<blockquote class="border-l-4 border-blue-400 pl-4 py-2 my-2 bg-blue-50 rounded-r">$1</blockquote>')
                .replace(/^\d+\. (.*$)/gm, '<li class="ml-5 mb-2 list-decimal">$1</li>')
                .replace(/^[-‚Ä¢] (.*$)/gm, '<li class="ml-5 mb-2 list-disc">$1</li>')
                .replace(/^---$/gm, '<hr class="my-6 border-gray-200">')
                .replace(/\n/g, '<br>');
        }
        
        // ========== MAIN API CALL ==========
        async function askQuestion() {
            const questionInput = document.getElementById('question');
            const question = questionInput.value.trim();
            const apiKey = DEFAULT_API_KEY;
            
            if (!question) {
                showToast(translations[currentLang].toastEmpty);
                return;
            }
            
            const loadingState = document.getElementById('loadingState');
            const askButton = document.getElementById('askButton');
            const chatMessages = document.getElementById('chatMessages');
            const welcomeSection = document.getElementById('welcomeSection');
            
            // Create new chat if needed
            if (!activeChatId) {
                createChat(question);
            }
            
            // Add user message
            addMessageToChat('user', question);
            
            // Show chat area
            welcomeSection.classList.add('hidden');
            chatMessages.classList.remove('hidden');
            
            // Render current messages
            const chat = getActiveChat();
            renderMessages(chat.messages);
            
            // Show loading
            loadingState.classList.remove('hidden');
            askButton.disabled = true;
            questionInput.value = '';
            
            // Scroll to loading
            loadingState.scrollIntoView({ behavior: 'smooth', block: 'end' });
            
            try {
                // Build messages array for API
                const apiMessages = [
                    { role: 'system', content: SYSTEM_PROMPT },
                    ...chat.messages.map(m => ({ role: m.role, content: m.content }))
                ];
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Akyykat AI - Legal Assistant for Kyrgyzstan'
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: apiMessages,
                        max_tokens: 4000,
                        temperature: 0.3
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'API Error');
                }
                
                let aiResponse = data.choices[0]?.message?.content;
                
                if (!aiResponse) {
                    throw new Error('Empty response');
                }
                
                // ===== CRITICAL: MULTI-PASS THINK TAG REMOVAL =====
                // DeepSeek/R1 models send reasoning in <think> tags
                
                // Pass 1: Main filter function
                aiResponse = filterThinkingTags(aiResponse);
                
                // Pass 2: Additional safety regex
                aiResponse = aiResponse.replace(/<think[\s\S]*?(?:<\/think>|$)/gi, '');
                aiResponse = aiResponse.replace(/<\/think>/gi, '');
                
                // Pass 3: If still starts with < (potential uncaught tag), clean more aggressively
                while (aiResponse.startsWith('<') && !aiResponse.startsWith('<strong') && !aiResponse.startsWith('<em') && !aiResponse.startsWith('<p')) {
                    const closeIdx = aiResponse.indexOf('>');
                    if (closeIdx > 0 && closeIdx < 50) {
                        aiResponse = aiResponse.substring(closeIdx + 1);
                    } else {
                        break;
                    }
                }
                
                // Pass 4: Remove any remaining think-related content
                aiResponse = aiResponse.replace(/\[thinking\][\s\S]*?\[\/thinking\]/gi, '');
                aiResponse = aiResponse.replace(/\*\*Thinking:\*\*[\s\S]*?\n\n/gi, '');
                
                // Final cleanup
                aiResponse = aiResponse.replace(/^\s*\n+/, '').trim();
                
                // Safety: if response is empty after filtering, show error
                if (!aiResponse || aiResponse.length < 10) {
                    aiResponse = translations[currentLang].errorApi + ': Response was filtered completely. Please try again.';
                }
                
                // Add AI response to chat
                addMessageToChat('assistant', aiResponse);
                
                // Re-render messages
                renderMessages(getActiveChat().messages);
                
                // Update chat list (title might have changed)
                renderChatList();
                
            } catch (error) {
                console.error('Error:', error);
                // Add error message
                addMessageToChat('assistant', `‚ùå ${translations[currentLang].errorTitle || 'Error'}: ${error.message}`);
                renderMessages(getActiveChat().messages);
            } finally {
                loadingState.classList.add('hidden');
                askButton.disabled = false;
            }
        }
        
        // ========== EVENT LISTENERS ==========
        document.getElementById('question').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                askQuestion();
            }
        });
        
        // Handle resize
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth >= 1024) {
                sidebar.classList.remove('open');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
        });
    </script>
</body>
</html>
